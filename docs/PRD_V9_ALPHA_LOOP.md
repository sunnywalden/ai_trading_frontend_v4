# PRD V9 — Alpha Loop（阿尔法闭环）

> 适用范围：个人美港股 AI 量化交易系统
> 文档版本：v9.0
> 日期：2026-02-09
> 前置版本：PRD_PERSONAL_TRADING v1.0（V1~V5）

---

## 1. 版本主题与使命

**Alpha Loop = 研判 → 计划 → 信号 → 执行 → 归因 → 复盘 → 改进 → 研判**

V8 完成了一个"能看不能动"的分析系统。V9 的使命是将系统升级为 **"看得到 → 算得出 → 做得了 → 复盘得了"** 的完整交易闭环。

### 1.1 核心差距（V8 审计结论）

| 维度 | V8 现状 | V9 目标 |
|------|---------|---------|
| 信号引擎 | 策略执行为随机模拟 | 真实因子驱动，可回测 |
| 执行能力 | MockOrderExecutor | Tiger 真实下单 + 模拟盘 |
| 资金曲线 | 无账户权益历史 | 每日快照 + ECharts 可视化 |
| 交易仪表盘 | 无 | 首页 Dashboard |
| 复盘系统 | 无 | 交易日志 + AI 自动复盘 |
| 通知推送 | 无 | WebSocket + Telegram |
| 价格告警 | 无 | 条件触发 + 半自动执行 |
| 安全加固 | 密码明文 / JWT 默认值 | bcrypt + 生产级安全 |

### 1.2 北极星指标

| 指标 | V8 现状 | V9 目标 |
|------|---------|---------|
| 交易闭环覆盖 | 60% | **100%** |
| 日常操作步数 | 10+ | **≤ 5** |
| 信号到通知延迟 | 无通知 | **< 3s** |
| 计划执行率可追踪 | 否 | **是，≥ 80%** |
| 最大回撤保护 | 无 | **自动熔断** |

---

## 2. 用户画像与场景

### 2.1 用户画像

- 个人交易者（美股+港股为主）
- 有 1-3 年交易经验，希望系统化管理
- 日均操作时间 < 30 分钟
- 使用 Tiger/富途等互联网券商

### 2.2 核心使用场景

| 场景 | 当前 | V9 |
|------|------|-----|
| 早盘 Check | 打开持仓页手动逐一查看 | Dashboard 一屏全览 |
| 发现机会 | 策略随机模拟结果 | 真实因子信号 + 回测验证 |
| 执行交易 | 离开系统到券商 APP | 系统内半自动执行 |
| 止损止盈 | 盯盘或遗忘 | 价格告警自动触发 |
| 盘后复盘 | 无 | AI 自动生成复盘报告 |
| 资金管理 | 无 | 资金曲线 + 回撤追踪 |

---

## 3. V9 功能清单（优先级排序）

### P0 — 本版必须交付

#### 3.1 交易仪表盘（Trading Dashboard）

**PRD V1 遗留的最大债务：个人交易者每日第一眼看到的页面。**

- 账户权益总览（总权益 / 现金 / 持仓市值）
- 今日盈亏（已实现 + 未实现）
- Greeks 水位图（复用 GreeksWaterLevel 组件）
- 资金曲线（近 30 天，ECharts）
- 今日计划执行率
- 今日信号 & 待办事项

**验收标准**：
- 页面加载 ≤ 2s
- 水位误差 ≤ 1%
- 首页直达，替代当前热点页为默认路由

#### 3.2 资金曲线 & PnL 归因

**交易员最核心的反馈工具。**

- 每日权益快照（收盘后自动采集）
- 累计收益 vs 基准（SPY）
- 月度/周度盈亏
- PnL 归因（按标的 / 按策略）
- 最大回撤区间标注

**验收标准**：
- 数据精度 ≤ $0.01
- 30 天以上历史数据可查

#### 3.3 真实策略信号引擎

**替换随机模拟为可运行的因子系统。**

- 因子库：动量（RSI 突破/MACD 金叉/均线多排）、均值回归（布林带极端/RSI 超卖）、量价、基本面
- 筛选器：标的池 + 过滤链（流动性/市值/风险等级）
- 回测引擎：事件驱动回测 → 绩效指标（Sharpe/Sortino/MaxDD/胜率/盈亏比）
- 信号聚合：多因子加权 → 最终信号 + 因子贡献度

**验收标准**：
- 每个信号附带因子贡献度和历史胜率
- 回测 Sharpe > 1.0（基准）

#### 3.4 交易执行层

**将 MockOrderExecutor 替换为可真实下单的执行器。**

- TigerOrderExecutor：Tiger OpenAPI 真实下单（US + HK）
- PaperOrderExecutor：模拟盘（按市场价模拟成交）
- 三级确认：DRY_RUN → PAPER → REAL
- 安全机制：
  - 单日损失熔断（日亏损超阈值自动 OFF）
  - 订单频率限制（每分钟最多 K 单）
  - 非交易时段禁止
  - Fat Finger Guard（单笔超净值 Y% 需确认）

**验收标准**：
- Paper 模式成交记录可查
- REAL 模式有二次确认
- 熔断触发后 30s 内停止所有下单

### P1 — 本版应该交付

#### 3.5 交易复盘系统（Trade Journal）

- 交易日志 CRUD
- 执行质量自评（1-5）
- 情绪标注（calm/anxious/revenge/fomo）
- 错误标签（卖飞/追高/无计划入场/提前止盈）
- AI 自动复盘（GPT 驱动）
- 周度/月度 AI 总结报告

**验收标准**：
- 复盘完成率 ≥ 80%
- AI 复盘覆盖每笔已执行交易

#### 3.6 价格告警 & 条件触发

- 告警规则：价格上穿/下穿、百分比变化、RSI 穿越、MACD 交叉
- 关联交易计划：止损/止盈自动注册为告警
- 触发动作：通知 或 半自动执行
- 告警历史可查

**验收标准**：
- 价格到位检测延迟 < 30s（延迟行情模式）
- 告警准确率 ≥ 99%

#### 3.7 通知系统

- WebSocket 实时推送（信号/价格/订单/风控）
- Telegram 推送（止损触发/大额亏损/系统异常）
- 桌面通知（复用已有前端基础）

**验收标准**：
- WebSocket 重连 < 5s
- 消息延迟 < 3s

### P2 — 本版努力交付

#### 3.8 回测可视化平台

- 策略参数配置面板
- 净值曲线 + 月度收益率
- 参数敏感性热力图
- 多策略对比

#### 3.9 安全加固

- 密码 bcrypt hash
- JWT Secret 启动强校验
- CORS 生产白名单
- API Rate Limiting
- 审计日志
- 结构化日志

---

## 4. 信息架构（V9）

```
首页 → 交易仪表盘 (Dashboard) [NEW]
├── 市场热点 (Hotspots)
├── 行为评分 (Behavior)
├── 持仓评估 (Positions)
├── 宏观分析 (Macro)
├── 策略筛选 (Opportunities)
├── 股票分析 (AI Advice)
├── 交易计划 (Plans)
├── 交易日志 (Journal) [NEW]
├── 资金曲线 (Equity) [NEW]
├── 价格告警 (Alerts) [NEW]
├── API 监控 (API Monitoring)
└── 系统健康 (System Health)
```

---

## 5. 数据模型新增（7 张表）

| 表名 | 用途 | 优先级 |
|------|------|--------|
| `equity_snapshots` | 每日账户权益快照 | P0 |
| `trade_pnl_attribution` | 交易盈亏归因 | P0 |
| `trade_journal` | 交易日志/复盘 | P1 |
| `price_alerts` | 价格告警规则 | P1 |
| `alert_history` | 告警触发历史 | P1 |
| `audit_logs` | 审计日志 | P2 |
| `notification_log` | 通知发送记录 | P1 |

---

## 6. API 新增

| 方法 | 路径 | 功能 | 优先级 |
|------|------|------|--------|
| GET | `/dashboard/summary` | 仪表盘聚合数据 | P0 |
| GET | `/equity/snapshots` | 资金曲线数据 | P0 |
| GET | `/equity/pnl-attribution` | PnL 归因 | P0 |
| POST | `/equity/snapshot` | 手动触发快照 | P0 |
| GET | `/journal/list` | 交易日志列表 | P1 |
| POST | `/journal/create` | 新建日志 | P1 |
| PATCH | `/journal/{id}` | 更新日志 | P1 |
| POST | `/journal/{id}/ai-review` | 触发 AI 复盘 | P1 |
| GET | `/alerts/list` | 告警规则列表 | P1 |
| POST | `/alerts/create` | 新建告警 | P1 |
| PATCH | `/alerts/{id}` | 更新告警 | P1 |
| DELETE | `/alerts/{id}` | 删除告警 | P1 |
| GET | `/alerts/history` | 告警触发历史 | P1 |
| WS | `/ws/trading` | WebSocket 实时通道 | P1 |
| POST | `/orders/submit` | 提交订单 | P0 |
| GET | `/orders/{id}/status` | 订单状态 | P0 |
| POST | `/orders/{id}/cancel` | 取消订单 | P0 |
| GET | `/backtest/run` | 运行回测 | P2 |
| GET | `/backtest/results/{id}` | 回测结果 | P2 |

---

## 7. 里程碑与排期

| Phase | 周期 | 交付内容 |
|-------|------|---------|
| Phase 1 | 4 weeks | Dashboard + 资金曲线 + Alembic + WebSocket 基础 |
| Phase 2 | 4 weeks | 因子库 + 信号引擎 + 回测核心 + PnL 归因 + 安全加固 |
| Phase 3 | 3 weeks | OrderExecutor + PaperTrade + 价格告警 + 熔断 + 通知 |
| Phase 4 | 3 weeks | 复盘系统 + AI 复盘 + 回测可视化 + Dashboard 前端 |
| Phase 5 | 2 weeks | E2E 测试 + 审计日志 + 性能优化 + 文档 |

---

## 8. 风险与决策

| 决策点 | 结论 | 理由 |
|--------|------|------|
| 真实下单进 V9？ | ✅ 进，强制 Paper 先行 | 不做执行层只是"高级看盘器" |
| A 股支持？ | ⚠️ P2 不阻塞 | 美港股闭环优先 |
| 引入 Celery？ | ❌ | APScheduler + Redis PubSub 足够 |
| 前端换框架？ | ❌ Vue 3 保留 | 引入 Pinia 即可 |
| 引入 ClickHouse？ | ❌ | MySQL 足够个人量级 |

---

## 9. 兼容性与降级策略

- 新 API 不可用时前端隐藏对应入口
- WebSocket 不可用时降级为轮询
- AI 复盘不可用时显示规则摘要
- Paper 订单独立于 Real 订单存储
- Dashboard 数据缺失时显示"暂无数据"+ 引导

---

## 10. 成功标准

完成 V9 后，系统应能支撑：
1. 一个个人交易者从"发现信号"到"执行交易"到"复盘改进"的完整日常工作流
2. 所有交易有计划、有执行、有归因、有复盘
3. 风险可量化、可追踪、超限自动保护
4. 策略可回测验证后再投入使用

---

**文档维护者**：AI Trading Team
**最后更新**：2026-02-09
